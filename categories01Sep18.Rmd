---
title: "Lag1 Correlations"
author: "Saurabh Gupta"
date: "31 August 2018"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# data folder
```{r}
# data folder
data.folder <- "C:/Users/saura/Dropbox (Personal)/STATS 790B/Data Extraction 25Aug18"


```

## load data

```{r}
load(paste0(data.folder, "/trainlag1.df.rda"))

data <- trainlag1.df
rm(trainlag1.df)

```

# bycategory barplot

```{r, fig.width=12}

#png(file = "bycategory.png", width = 720, height = 480)

pdf(file = "bycategory.pdf", width = 10)
catnames <- names(sort(table(data$Category, useNA = "ifany")))
catnames[catnames == "Drawing & Painting"] <- "Painting"

barplot(sort(table(data$Category, useNA = "ifany")/23), 
        ylab = "No. of Creators",
        #cex.names = 1,
        main = "Creators by Category",
        #space = 1,
        names = catnames
        )
dev.off()
```


# pairs plots of only video producers

## data matrix

```{r}
X <- data[data$Category == "Video", ]


X <- as.matrix(Filter(is.numeric, X))


```


## Renate's function for a more informative pairs plot


```{r}

panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...)
{
usr <- par("usr"); on.exit(par(usr))
par(usr = c(0, 1, 0, 1))

r <- cor(x, y, use = "pairwise.complete.obs")

txt <- format(c(r, 0.123456789), digits = digits)[1]

txt <- paste0(prefix, txt)

#if(missing(cex.cor)) 
cex.cor <- 0.8/strwidth(txt)

# min text size 
cexnew <- cex.cor * abs(r)
cexnew[cexnew < 1.4] <- 1.4
    
text(0.5, 0.5, txt, cex = cexnew)
# print(cexnew)
}

```

# Pairs Plot

```{r}

#png(file = "pairsvideo.png", width = 960, height = 960)

pairs(X, lower.panel = panel.smooth, upper.panel = panel.cor, cex = 0.7, main = "Video Creators")

#dev.off()
```

# Smooth pairs

```{r}

# nrpoints is number of outliers to be plotted

pdf(file = "pairsvideo.pdf")

pairs(X, upper.panel = panel.cor, cex = 0.7, 
      main = "Video Creators", lower.panel = function(...){smoothScatter(..., nrpoints = 50, add = TRUE)}, gap = 0.2)

dev.off()
```

# pairs for log X

```{r}
logX <- X

logX[logX == 0] <- NA

logX <- log(logX)


# nrpoints is number of outliers to be plotted

pdf(file = "pairsvideo_logxy.pdf")

pairs(logX, upper.panel = panel.cor, cex = 0.7, 
      main = "Video Creators (log transformed data)", 
      lower.panel = function(...){smoothScatter(..., nrpoints = 50, add = TRUE)}, gap = 0.2)

dev.off()

```


# VGAM ##

Social media could have diminishing returns. So subset outliers of Twitter followers.

Music category is very different. It has the most outliers and skewness followed by video.

So let's focus on video cqategory

## Twitter subset

```{r}

# boxplot
boxtwitter <- boxplot(trainlag1.df$Twitter.Followers ~ trainlag1.df$Category, cex = 0.8)

# boxtwitter <- boxplot(trainlag1.df$Twitter.Followers, plot = FALSE)

# minimum value of outlier for video
(min.out <- min(boxtwitter$out[boxtwitter$group == 7]))
min.out <- signif(min.out, digits = 1)

# subset video category 
data <- subset(trainlag1.df, trainlag1.df$Category == "Video")
nrow(data)

(quants <- quantile(data$Twitter.Followers,
                   probs = c(0.25, 0.5, 0.75, 0.85, 0.9, 0.95),
                   na.rm = TRUE))

# subset twitter ourliers
data <- subset(data, data$Twitter.Followers < min.out)

nrow(data)

boxplot(data$Twitter.Followers)


```

Smooth Scatter

```{r}

y = data$Patrons
x = data$Twitter.Followers

#plot(x, y)

smoothScatter(x, y ,
              xlab = "Twitter.Followers < 200,000", 
              ylab = "Patrons",
              main = "Smooth Scatter Plot")

```

# VGAM

```{r}
library(VGAM)

# percentiles required
mypercentiles <- c(5, 25, 50, 75, 95)
```

Remove NA and NULL values

```{r}
vgamdata <- data[, c("Patrons", "Twitter.Followers")]
nrow(vgamdata)

vgamdata <- na.exclude(vgamdata)
nrow(vgamdata)

vgamdata <- vgamdata[!is.null(vgamdata),]
nrow(vgamdata)

sum(apply(vgamdata, 2, FUN = is.nan))


```

# GAM

```{r}
library(mgcv)

```


```{r}
video_gam <- gam(Patrons ~ s(Twitter.Followers), data = vgamdata, family = "quasipoisson")

plot(video_gam)
```

Each creator's relationship is independent. But it seems to be positively correlated.

Next step is to create a histogram of correlations for video creators with twitter followers < 2e+5

```{r}
plot(vgamdata)
```


# Histogram of Correlations ##############

## load data

```{r}

# to be corrected
load(paste0(data.folder, "/trainallvars.rda"))

```

## subset video creators

```{r}

video.fun <- function(x){
  if(x$Category[3] == "Video"){x}else{NA}
}
  
video.creators <- lapply(trainallvars, FUN = video.fun)

names(video.creators) <- names(trainallvars)

video.creators <- video.creators[!is.na(video.creators)]

save(video.creators, file = "video.creators.rda")

```

# load video creators

```{r}
load(paste0(data.folder, "/video.creators.rda"))
```


## function for correlations

```{r}

# function to compute correlations

corr.fun <- function(x){
  
    x <- Filter(is.numeric, x)
    round(cor(x, use = "pairwise.complete.obs",
              method = "pearson")[1,], 2)
} 

data <- video.creators

```

## create list

```{r}
# create list
corr.list <- lapply(data, FUN = corr.fun)

# Convert to dataframe
(plot.df <- corr.list[[1]])

for (i in 2:length(corr.list)){
  plot.df <- rbind(plot.df, corr.list[[i]])
}

```



## histogram

```{r}
# column names
cnames <- colnames(plot.df)

xlab <- "Lag 1 Correlation with Patrons" 

hist(plot.df[,3], main = paste0("Video Creators: ", cnames[3]), xlab = xlab)

```

## plot for latex

```{r}
pdf(file = "videocorrlag1.pdf", height = 9, paper = "a4")

# Common Title
par(mfrow = c(3,2))
#par(mar = par("mar") + c(0,0,1,0))

for(j in 2:dim(plot.df)[2]){
      hist(plot.df[,j],
           main = paste0("Video Creators: ", cnames[j]),
           xlab = xlab
           )
}

# mtext doesn't work with hist
# mtext("Correlation with log growth of patrons",
#        side = 3, outer = TRUE)
        
dev.off()
```

# Lag 1 Video correlations

```{r}
# Create data frame from trainlag1.rda 
load(paste0(data.folder, "/trainlag1.rda"))
```

subset data

```{r}

video.creators <- lapply(trainlag1, FUN = video.fun)

names(video.creators) <- names(trainlag1)

video.creators <- video.creators[!is.na(video.creators)]

video.lag1 <- video.creators

save(video.lag1, file = "video.lag1.rda")

```


use the code above for plots

```{r}

data <- video.lag1

```



# Not required xxxxxxxxxxxxxx

Pairs Plot - log growth
there is no column called category

Outliers - not required

```{r}

for(i in 1:ncol(X)){
  boxplot(X[X[, "Patrons"] < 5000, i], main = colnames(X)[i])
}


for(i in 1:ncol(X)){
  boxplot(X[X[, "Facebook.Likes"] < 5e5, i], main = colnames(X)[i])
}


for(i in 1:ncol(X)){
  boxplot(X[X[, "Twitter.Followers"] < 5e4, i], main = colnames(X)[i])
}

```


## Without Outliers 

## Twitter.Followers


```{r}

Xsub <- X[X[ ,"Twitter.Followers"] > 5e4 &
            
           X[ ,"Twitter.Followers"] < 4e5 , ]

Xsub <- X[X[ ,"Twitter.Followers"] < 1e5, ]

pairs(Xsub , upper.panel = panel.cor, cex = 0.7, 
      main = "Video Creators", lower.panel = function(...){smoothScatter(..., nrpoints = 50, add = TRUE)}, gap = 0.2)

```

## Patrons

```{r}
Xsub <- X[X[ ,"Patrons"] < 3000 , ]

Xsub <- X[X[ ,"Patrons"] > 3000 , ]

pairs(Xsub , upper.panel = panel.cor, cex = 0.7, 
      main = "Video Creators", lower.panel = function(...){smoothScatter(..., nrpoints = 50, add = TRUE)}, gap = 0.2)
```

## Youtube.Views



