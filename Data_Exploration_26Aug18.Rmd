---
title: "Data Exploration"
author: "Saurabh Gupta"
date: "26 August 2018"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

completed - plot number of patrons
next step - plot log growth and its qq norm plot. for qq norm plot, I can bunch all the observations together

# Load data

```{r}

datadir <- "C:/Users/saura/Dropbox (Personal)/STATS 790B/Data Extraction 25Aug18/"

load(paste0(datadir,"plot.qq.rda"))

load(paste0(datadir,"plot.patrons.rda"))

load(paste0(datadir,"art.names.rda"))

```


```{r}
# destination folder
dest.folder <- "C:/Users/saura/Dropbox (Personal)/STATS 790B/Dissertation Latex/figures"
```


# Number of patrons

```{r}
n <- length(plot.patrons)
```


Seperate artists depending on min and max values

```{r}
ymax <- sapply(plot.patrons, FUN = max)

ymin <- sapply(plot.patrons, FUN = min)

plot(ymax, ymin, type = "n")
text(ymax, ymin, labels = 1:10, cex = 0.8, offset = 1)

```

# Table of all variables for 1 creator

```{r}
library(xtable)

load(paste0(datadir,"trainallvars.rda"))
```

```{r}

tabledata <- trainallvars[[1]][, -c(1,2)]
rownames(tabledata) <- 1:nrow(tabledata)

tabledata[, -8] <- apply(tabledata[,-8], MARGIN = 2, FUN = function(x){
              prettyNum(x, format = "d",  big.mark = ",")
                })

tabledata[,8] <- as.character(tabledata[,8])
                           
tabledata <- tabledata[, c(8, 1, 3:7)]

rownames(tabledata) <- NULL
tabledata

xtable(tabledata)
```


subset creators with patrons < 3000

```{r}
cutoff <- 3000
over3k <- c(1, 7, 8, 10)
(under3k <- (1:n)[-over3k])

```

## Subset on patron size

```{r}
# data to be used

plot.list <- plot.patrons

months <- 1:24
```


y limits for patrons < 3000

```{r}
(ymax1 <- max(unlist(plot.list[under3k])))
(ymin1 <- min(unlist(plot.list[under3k])))

(ymax1 <- signif(10^(round(log10(ymax1), 2)), digits = 2))
(ymin1 <- 10^(floor(log10(ymin1))))
```

y limits for greater than

```{r}
(ymax2 <- max(unlist(plot.list[over3k])))
(ymin2 <- min(unlist(plot.list[over3k])))

(ymax2 <- signif(10^(round(log10(ymax2), 2)), digits = 3))
(ymin2 <- 10^(floor(log10(ymin2))))
```

## Make 2 plots - above and below 3k

```{r }
cexpch = 0.8

pdf(file = "Patrons.pdf")

par(mfrow = c(2,1), cex = cexpch)
par(mar = par("mar") + c(0,1,0,0))

# creators > 3k
index <- over3k

for(j in 1:length(index)){
  if(j == 1){
    plot(x = months, y = plot.list[[index[j]]],
         type = "p", pch = j+1,
         main = paste0("Random Creators (with > ", cutoff, " patrons)" ),
         ylab = "Number of Patrons",
         xlab = "Month (day 1)",
         ylim = c(ymin2, ymax2) , cex = cexpch
         )
        }else{
    points(x = months, plot.list[[index[j]]],
           pch = j+1, cex = cexpch)
        }
  lines(x = months, y = plot.list[[index[j]]])
}

# creators < 3k
index <- under3k

for(j in 1:length(index)){
  if(j == 1){
    plot(x = months, y = plot.list[[index[j]]],
         type = "p", pch = j+1,
         
         main = paste0("Random Creators (with < ", cutoff, " patrons)" ),
         ylab = "Number of Patrons",
         xlab = "Month (day 1)",
         ylim = c(ymin1, ymax1) , cex = cexpch
         )
        }else{
    points(x = months, plot.list[[index[j]]],
           pch = j+1, cex = cexpch)
        }
  lines(x = months, y = plot.list[[index[j]]])
}

dev.off()

```

## Single plot for all creators 


```{r, fig.width= 9}

png(file = "Patrons1.png", width = 960, height = 960)

par(mar = par("mar") + c(0,1,0,0))

for(j in 1:n){
  if(j == 1){
    plot(x = months, y = plot.list[[j]],
         pch = j,
         main = paste0("Time series of ", n, " random creators"),
         ylab = "Number of Patrons",
         xlab = "Month (day 1)",
         ylim = c(ymin1, ymax2),
         cex.main = 1.4,
         cex.lab = 1.4,
         cex.axis = 1.4
         )
        }else{
    points(x = months, plot.list[[j]],
           pch = j)
        }
  lines(x = months, y = plot.list[[j]])
}

dev.off()
```

# Log Return plots

## Setup arguments

```{r}
# Setup arguments
months <- 1:23

plot.list <- plot.qq
```

y limits 

```{r}
(ymax <- max(unlist(plot.qq)))
(ymin <- min(unlist(plot.qq)))

(ymax <- round(log10(round(10^ymax, digits = 1)), 2))
(ymin <- round(log10(round(10^ymin, digits = 1)), 2))
```

## the plot

### single plot

```{r}

png(file = "LogGrowth1.png", width = 960, height = 480)

par(mar = par("mar") + c(0,1,0,0))

for(j in 1:n){
  if(j == 1){
    plot(x = months, y = plot.list[[j]],
         pch = j,
         main = paste0("Monthly Growth in Patrons for ", n, " random creators"),
         ylab = "Log Monthly Growth in Patrons",
         xlab = "Month (day 1)",
         ylim = c(ymin, ymax),
         cex.main = 1.4,
         cex.lab = 1.4,
         cex.axis = 1
         )
        }else{
    points(x = months, plot.list[[j]],
           pch = j)
        }
  lines(x = months, y = plot.list[[j]])
}

dev.off()
```

## Make 2 plots - above and below 3k

y limits for patrons < 2800

```{r}
(ymax1 <- max(unlist(plot.list[under3k])))
(ymin1 <- min(unlist(plot.list[under3k])))

(ymax1 <- round(log10(round(10^ymax1, digits = 1)), 2))
(ymin1 <- round(log10(round(10^ymin1, digits = 1)), 2))
```

y limits for greater than

```{r}
(ymax2 <- max(unlist(plot.list[over3k])))
(ymin2 <- min(unlist(plot.list[over3k])))

(ymax2 <- round(log10(round(10^ymax2, digits = 1)), 2))
(ymin2 <- round(log10(round(10^ymin2, digits = 1)), 2))
```

```{r}
cexpch = 0.8
# file = "LogGrowth.pdf"

pdf(file = "Patrons_quad.pdf")

par(mfrow = c(2,1), cex = cexpch)
par(mar = par("mar") + c(0,1,0,0))

# creators > 3k
index <- over3k

for(j in 1:length(index)){
  if(j == 1){
    plot(x = months, y = plot.list[[index[j]]],
         type = "p" , pch = j+1,
         cex = cexpch,
         main = paste0("Random Creators (with > ", cutoff, " patrons)" ),
         ylab = "Log Monthly Growth in Patrons",
         xlab = "Month (day 1)",
         ylim = c(ymin2, ymax2)
         )
        }else{
    points(x = months, plot.list[[index[j]]],
           pch = j+1, cex = cexpch)
        }
  lines(x = months, y = plot.list[[index[j]]])
}

# creators < 3k
index <- under3k

for(j in 1:length(index)){
  if(j == 1){
    plot(x = months, y = plot.list[[index[j]]],
         type = "p" , pch = j+1,
         cex = cexpch,
         main = paste0("Random Creators (with < ", cutoff, " patrons)" ),
         ylab = "Log Monthly Growth in Patrons",
         xlab = "Month (day 1)",
         ylim = c(ymin1, ymax1)
         )
        }else{
    points(x = months, plot.list[[index[j]]],
           pch = j+1, cex = cexpch)
        }
  lines(x = months, y = plot.list[[index[j]]])
}

dev.off()

```

# QQ norm plots

## Setup arguments

```{r}
# Setup arguments
months <- 1:23

plot.list <- plot.qq
```

## explore t dist on qqnorm

```{r}
qqnorm(rt(100, df = 3))

#qqnorm(unlist(plot.list),
#       main = "Normal QQ Plot")
#qqline(unlist(plot.list))
```


```{r}
pdf(file = "densitylg.pdf", height = 7, width = 14)

par(mfrow = c(1,2), cex = 1.5)
plot(density(unlist(plot.list)),
     main = "Kernel Density",
     sub = "For exploration dataset")

qqnorm(unlist(plot.list),
       main = "Normal QQ Plot",
       sub = "For exploration dataset")
qqline(unlist(plot.list))

dev.off()

file.show("densitylg.pdf")

# qqplot(x = qt(ppoints(length(unlist(plot.list))), df = 7), y = unlist(plot.list), main = "t distribution QQ Plot")
```

# Stationarity Tests

## Autocorrelation of log growth


```{r, fig.height= 16, fig.width=9}

png(file = "acf.png", width = 960, height = 1440)

# Common Title
par(mfrow = c(5,2))
par(mar = par("mar") + c(0,0,1,0))

for(j in 1:length(plot.list)){
      acf(plot.list[[j]],
    main = paste0("Creator ", j))
  mtext("Autocorrelation of Log Growth",
        side = 3, outer = TRUE)
}
    
dev.off()

```

## Partial Autocorrelation of log growth

autocovariance looks similar but doesn't give the significance boundary so quite meaningless. Hence, I have removed it.

```{r, fig.height= 16, fig.width=9}

png(file = "pacf.png", width = 960, height = 1440)

# Common Title
par(mfrow = c(5,2))
par(mar = par("mar") + c(0,0,1,0))

for(j in 1:length(plot.list)){
      pacf(plot.list[[j]],
          main = paste0("Creator ", j))
}

dev.off()

```



## Augmented Dickey-Fuller Test


```{r}

library(tseries)

adf.test <- unlist(lapply(plot.list, FUN = 
                     function(x){
                       adf.test(x)$p.value}
                   ))

names(adf.test) <- 1:n
```

```{r}

png(file = "adftest.png")
barplot(adf.test, main = "Augmented Dickey Fuller Test", ylab = "p.value", xlab = "Creator")
dev.off()
```

# Plot all variables in 1 plot


```{r}
load(paste0(datadir, "trainallvars.rda"))
```


## random index

```{r}
# need to get the same sample everytime
set.seed(1234)

# create index for random artists
art.index <- length(trainallvars)

months <- 1:length(trainallvars[[1]][,1])

# number of artists for which data is required
n = 10
rand.index <- sample(art.index, n)
```


## extract data

```{r}
plot.allvars <- vector("list", n)

j = 1
for(i in rand.index){
  plot.allvars[[j]] <- trainallvars[[i]]
  j = j+1
  print(i)
}

# save(plot.allvars, file = "plot.allvars.rda")
```


load data if required

```{r}
load("plot.allvars.rda")
```

Lisa Clough is 3rd

Mega64 is 5th

Amanda is in 7th in the list

Nintendo Force is 8th

```{r}
lapply(plot.allvars, FUN = 
         function(x){x$Name[3]})
```

Set up

```{r}
index <- c(3, 5, 7, 8)

plot.list <- plot.allvars[index]
art.names <- art.names[index]

# artist names
# art.names[index]

plot.list <- lapply(plot.list, FUN = 
                      function(x){
                        # exclude earnings
                        x <- Filter(is.numeric, x)[ , -2]
                        
                        # YT videos divide by 1000
                        #include = c(2, 3, 6)
                        #x[ , include] <- x[ , include]/1000
                        
                        # except Patrons and YouTube videos
                        exclude <- -c(1, 5)
                        x[ , exclude] <- x[ , exclude]/100
                        
                        return(x[,-6])
                      })   

ncols = dim(plot.list[[1]])[2]

col.index <- 1:ncols

cexpch = 1.6

```


```{r, fig.height= 24, fid.width = 6}


pdf(file = "allvars.pdf", paper = "a4")

# Expand bottom of clipping rect to make room for the legend
par(xpd=T, mar=par()$mar + c(6, 0, 0,0))

par(mfrow = c(length(index),1))

for(j in 1: length(index)){
  # j is the creator index
  data <- plot.list[[j]]
  
  ymax = max(data)
  ymin = min(data)
  
  for(k in col.index){
  
    # new plot for the first column
    if(k == 1){
      plot(x = months, y = data[ , k ],
         type = "p", pch = k, col = k,
         main = art.names[j],
         ylab = "Number",
         xlab = "Month (day 1)",
         ylim = c(ymin, ymax),
         cex = cexpch
         )
        }else{
    points(x = months, y = data[ , col.index[k] ],
           pch = k, col = k, cex = cexpch)
        }
  lines(x = months, y = data[ , col.index[k] ] )
  }
}

legend( "bottom" , legend = colnames(data),
      lty = 1, pch = col.index, col = col.index, 
       inset = c(0, -0.2),
      horiz = TRUE
       )

dev.off()

# Restore default clipping rect
par(mar=c(5, 4, 4, 2) + 0.1)
```





























